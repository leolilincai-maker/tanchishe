<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="format-detection" content="telephone=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="è´ªåƒè›‡æ¸¸æˆ">
    <meta name="msapplication-tap-highlight" content="no">
    <meta name="theme-color" content="#27ae60">
    <meta name="description" content="ç»å…¸è´ªåƒè›‡æ¸¸æˆï¼Œæ”¯æŒå¤šç§é£Ÿç‰©å’Œé€Ÿåº¦è°ƒèŠ‚">
    <meta name="keywords" content="è´ªåƒè›‡,æ¸¸æˆ,ä¼‘é—²,ç»å…¸">
    <meta name="author" content="Leo Li">
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="manifest.json">
    
    <!-- Apple Touch Icons -->
    <link rel="apple-touch-icon" href="icons/icon-192x192.png">
    <link rel="apple-touch-icon" sizes="152x152" href="icons/icon-152x152.png">
    <link rel="apple-touch-icon" sizes="180x180" href="icons/icon-180x180.png">
    <link rel="apple-touch-icon" sizes="167x167" href="icons/icon-167x167.png">
    
    <!-- Favicon -->
    <link rel="icon" type="image/png" sizes="32x32" href="icons/icon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="icons/icon-16x16.png">
    
    <title>è´ªåƒè›‡æ¸¸æˆ</title>
    
    <!-- éŸ³æ•ˆç³»ç»Ÿ -->
    <style>
        #soundControls {
            position: fixed;
            top: 20px;
            right: 80px;
            z-index: 1001;
        }
        
        .soundBtn {
            width: 45px;
            height: 45px;
            background: #3498db;
            border: none;
            border-radius: 50%;
            color: white;
            font-size: 20px;
            cursor: pointer;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
            -webkit-tap-highlight-color: transparent;
            touch-action: manipulation;
            -webkit-appearance: none;
        }
        
        .soundBtn:active,
        .soundBtn:focus {
            transform: scale(0.9);
            -webkit-transform: scale(0.9);
            outline: none;
        }
        
        .soundBtn.muted {
            background: #e74c3c;
        }
    </style>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            user-select: none;
        }
        
        html, body {
            width: 100vw;
            height: 100vh;
            overflow: hidden;
            position: fixed;
            -webkit-overflow-scrolling: touch;
            background: #2c3e50;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }
        
        body {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            touch-action: none;
            padding: env(safe-area-inset-top) env(safe-area-inset-right) env(safe-area-inset-bottom) env(safe-area-inset-left);
        }
        
        #installPrompt {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background: #3498db;
            color: white;
            padding: 15px;
            text-align: center;
            z-index: 10000;
            display: none;
            box-shadow: 0 2px 10px rgba(0,0,0,0.3);
        }
        
        #installPrompt button {
            background: #e74c3c;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            margin-left: 10px;
            cursor: pointer;
            font-weight: 500;
        }
        
        #installPrompt .close {
            background: transparent;
            border: 1px solid white;
            margin-left: 10px;
        }
        
        #speedSelection {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: #2c3e50;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            padding: 20px;
            -webkit-transform: translateZ(0);
        }
        
        #speedSelection h1 {
            color: white;
            font-size: 24px;
            margin-bottom: 30px;
            text-align: center;
            font-weight: 600;
        }
        
        .speedButton {
            width: 100%;
            max-width: 280px;
            height: 60px;
            margin: 10px 0;
            background: #3498db;
            border: none;
            border-radius: 8px;
            color: white;
            font-size: 18px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            -webkit-tap-highlight-color: transparent;
            touch-action: manipulation;
            position: relative;
            overflow: hidden;
            -webkit-transform: translateZ(0);
            -webkit-appearance: none;
        }
        
        .speedButton:active,
        .speedButton:focus {
            background: #2980b9;
            transform: scale(0.98);
            -webkit-transform: scale(0.98);
            outline: none;
        }
        
        #gameContainer {
            position: relative;
            width: 100vw;
            height: 100vh;
            background: #27ae60;
            display: none;
            -webkit-transform: translateZ(0);
            overflow: hidden;
            border-radius: 0;
            box-shadow: none;
        }
        
        #gameCanvas {
            display: block;
            background: #27ae60;
            width: 100%;
            height: 100%;
            -webkit-transform: translateZ(0);
        }
        
        #ui {
            position: absolute;
            top: 20px;
            left: 20px;
            color: white;
            font-size: 18px;
            font-weight: 600;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
            z-index: 10;
        }
        
        #controls {
            position: fixed;
            bottom: 20px;
            left: 0;
            right: 0;
            display: flex;
            flex-direction: column;
            gap: 15px;
            align-items: center;
            z-index: 100;
            background: #2c3e50;
            padding: 15px;
            border-radius: 0 0 12px 12px;
        }
        
        .control-row {
            display: flex;
            gap: 20px;
            justify-content: center;
        }
        
        .control-btn {
            width: 80px;
            height: 80px;
            background: #3498db;
            border: none;
            border-radius: 50%;
            color: white;
            font-size: 32px;
            font-weight: bold;
            cursor: pointer;
            user-select: none;
            touch-action: manipulation;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            transition: all 0.2s ease;
            -webkit-tap-highlight-color: transparent;
            position: relative;
            overflow: hidden;
            -webkit-transform: translateZ(0);
            -webkit-appearance: none;
        }
        
        .control-btn:active,
        .control-btn:focus {
            transform: scale(0.9);
            -webkit-transform: scale(0.9);
            box-shadow: 0 2px 6px rgba(0,0,0,0.3);
            background: #2980b9;
            outline: none;
        }
        
        #gameOver {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            -webkit-transform: translate(-50%, -50%);
            background: rgba(0,0,0,0.9);
            color: white;
            padding: 30px;
            border-radius: 12px;
            text-align: center;
            display: none;
            box-shadow: 0 8px 32px rgba(0,0,0,0.5);
            z-index: 200;
        }
        
        #gameOver h2 {
            font-size: 28px;
            margin-bottom: 20px;
            font-weight: 600;
        }
        
        #restartBtn {
            margin-top: 25px;
            padding: 15px 30px;
            background: #e74c3c;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 18px;
            font-weight: 500;
            cursor: pointer;
            transition: background 0.2s ease;
            -webkit-tap-highlight-color: transparent;
            touch-action: manipulation;
            -webkit-appearance: none;
        }
        
        #restartBtn:active,
        #restartBtn:focus {
            background: #c0392b;
            outline: none;
        }
        
        #helpBtn {
            position: fixed;
            top: 20px;
            right: 20px;
            width: 45px;
            height: 45px;
            background: #3498db;
            border: none;
            border-radius: 50%;
            color: white;
            font-size: 22px;
            font-weight: bold;
            cursor: pointer;
            z-index: 1001;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
            -webkit-tap-highlight-color: transparent;
            touch-action: manipulation;
            -webkit-appearance: none;
        }
        
        #helpBtn:active,
        #helpBtn:focus {
            transform: scale(0.9);
            -webkit-transform: scale(0.9);
            outline: none;
        }
        
        #instructions {
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(0,0,0,0.8);
            color: white;
            padding: 15px;
            border-radius: 8px;
            font-size: 14px;
            max-width: 250px;
            display: none;
            line-height: 1.4;
            z-index: 300;
        }
        
        /* PWAç‰¹å®šæ ·å¼ */
        @media (display-mode: standalone) {
            body {
                padding-top: 0;
            }
            
            #installPrompt {
                display: none !important;
            }
        }
        
        /* å¾®ä¿¡æµè§ˆå™¨ç‰¹æ®Šä¼˜åŒ– */
        @supports (-webkit-touch-callout: none) {
            .speedButton,
            .control-btn,
            #restartBtn,
            #helpBtn {
                -webkit-touch-callout: none;
                -webkit-user-select: none;
                -webkit-tap-highlight-color: transparent;
            }
        }
        
        /* å¾®ä¿¡æµè§ˆå™¨ç‰¹æ®Šå¤„ç† */
        @media screen and (-webkit-min-device-pixel-ratio: 2) {
            .speedButton {
                min-height: 60px;
                font-size: 18px;
            }
            
            .control-btn {
                min-width: 80px;
                min-height: 80px;
                font-size: 32px;
            }
        }
        
        /* é˜²æ­¢å¾®ä¿¡æµè§ˆå™¨çš„å„ç§å¹²æ‰° */
        @media screen and (max-width: 768px) {
            body {
                padding: 0;
            }
            
            #gameContainer {
                width: 100vw;
                height: 100vh;
            }
        }
    </style>
</head>
<body>
    <!-- PWAå®‰è£…æç¤º -->
    <div id="installPrompt">
        <span>å°†è´ªåƒè›‡æ¸¸æˆæ·»åŠ åˆ°ä¸»å±å¹•ï¼Œè·å¾—æ›´å¥½çš„ä½“éªŒï¼</span>
        <button id="installBtn">å®‰è£…</button>
        <button class="close" id="closeInstall">âœ•</button>
    </div>

    <!-- éŸ³æ•ˆæ§åˆ¶æŒ‰é’® -->
    <div id="soundControls">
        <button id="musicBtn" class="soundBtn" title="èƒŒæ™¯éŸ³ä¹">ğŸµ</button>
        <button id="soundBtn" class="soundBtn" title="éŸ³æ•ˆ">ğŸ”Š</button>
    </div>
    
    <!-- å¸®åŠ©æŒ‰é’® -->
    <button id="helpBtn" title="æ¸¸æˆè¯´æ˜">?</button>
    <div id="instructions">
        <strong>æ¸¸æˆè¯´æ˜ï¼š</strong><br>
        â€¢ ç‚¹å‡»æ–¹å‘æŒ‰é’®æ§åˆ¶è›‡çš„ç§»åŠ¨<br>
        â€¢ åƒåˆ°é£Ÿç‰©è·å¾—åˆ†æ•°<br>
        â€¢ é¿å…æ’å¢™æˆ–æ’åˆ°è‡ªå·±<br>
        â€¢ æ¸¸æˆç»“æŸåç‚¹å‡»Restarté‡æ–°å¼€å§‹<br><br>
        <strong>PWAåŠŸèƒ½ï¼š</strong><br>
        â€¢ å¯ä»¥æ·»åŠ åˆ°ä¸»å±å¹•<br>
        â€¢ ç¦»çº¿è¿è¡Œ<br>
        â€¢ åƒåŸç”ŸAPPä¸€æ ·ä½¿ç”¨
    </div>

    <!-- é€Ÿåº¦é€‰æ‹©ç•Œé¢ -->
    <div id="speedSelection">
        <h1>é€‰æ‹©æ¸¸æˆé€Ÿåº¦</h1>
        <button class="speedButton" data-speed="1">Level 1 - æœ€æ…¢</button>
        <button class="speedButton" data-speed="2">Level 2 - æ…¢</button>
        <button class="speedButton" data-speed="3">Level 3 - æ­£å¸¸</button>
        <button class="speedButton" data-speed="4">Level 4 - å¿«</button>
        <button class="speedButton" data-speed="5">Level 5 - æœ€å¿«</button>
    </div>

    <!-- æ¸¸æˆç•Œé¢ -->
    <div id="gameContainer">
        <canvas id="gameCanvas"></canvas>
        <div id="ui">
            <div>åˆ†æ•°: <span id="score">0</span></div>
            <div>é€Ÿåº¦: Level <span id="speed">3</span></div>
        </div>
        <div id="gameOver">
            <h2>æ¸¸æˆç»“æŸ!</h2>
            <p>æœ€ç»ˆåˆ†æ•°: <span id="finalScore">0</span></p>
            <button id="restartBtn">é‡æ–°å¼€å§‹</button>
        </div>
    </div>
    
    <div id="controls">
        <div class="control-row">
            <button class="control-btn" id="upBtn">â†‘</button>
        </div>
        <div class="control-row">
            <button class="control-btn" id="leftBtn">â†</button>
            <button class="control-btn" id="downBtn">â†“</button>
            <button class="control-btn" id="rightBtn">â†’</button>
        </div>
    </div>

    <script>
        // PWA Service Worker æ³¨å†Œ
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', function() {
                navigator.serviceWorker.register('sw.js')
                    .then(function(registration) {
                        console.log('ServiceWorker registration successful');
                    })
                    .catch(function(err) {
                        console.log('ServiceWorker registration failed');
                    });
            });
        }

        // PWA å®‰è£…æç¤º
        let deferredPrompt;
        const installPrompt = document.getElementById('installPrompt');
        const installBtn = document.getElementById('installBtn');
        const closeInstall = document.getElementById('closeInstall');

        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            installPrompt.style.display = 'block';
        });

        installBtn.addEventListener('click', (e) => {
            installPrompt.style.display = 'none';
            deferredPrompt.prompt();
            deferredPrompt.userChoice.then((choiceResult) => {
                if (choiceResult.outcome === 'accepted') {
                    console.log('User accepted the install prompt');
                } else {
                    console.log('User dismissed the install prompt');
                }
                deferredPrompt = null;
            });
        });

        closeInstall.addEventListener('click', () => {
            installPrompt.style.display = 'none';
        });

        // éŸ³æ•ˆç³»ç»Ÿ
        let audioContext;
        let musicEnabled = true;
        let soundEnabled = true;
        let backgroundMusic;
        let musicBtn = document.getElementById('musicBtn');
        let soundBtn = document.getElementById('soundBtn');
        
        // åˆå§‹åŒ–éŸ³æ•ˆç³»ç»Ÿ
        function initAudio() {
            try {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
                console.log('éŸ³æ•ˆç³»ç»Ÿåˆå§‹åŒ–æˆåŠŸ');
            } catch (e) {
                console.log('éŸ³æ•ˆç³»ç»Ÿåˆå§‹åŒ–å¤±è´¥:', e);
            }
        }
        
        // ç”ŸæˆéŸ³æ•ˆ
        function playSound(frequency, duration, type = 'sine') {
            if (!audioContext || !soundEnabled) return;
            
            try {
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                oscillator.frequency.setValueAtTime(frequency, audioContext.currentTime);
                oscillator.type = type;
                
                gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + duration);
                
                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + duration);
            } catch (e) {
                console.log('æ’­æ”¾éŸ³æ•ˆå¤±è´¥:', e);
            }
        }
        
        // æ’­æ”¾èƒŒæ™¯éŸ³ä¹ï¼ˆä½¿ç”¨éŸ³è°ƒåºåˆ—ï¼‰
        function playBackgroundMusic() {
            if (!audioContext || !musicEnabled) return;
            
            const notes = [262, 294, 330, 349, 392, 440, 494, 523]; // Cå¤§è°ƒéŸ³é˜¶
            let noteIndex = 0;
            
            function playNote() {
                if (!musicEnabled) return;
                
                const frequency = notes[noteIndex];
                playSound(frequency, 0.5, 'triangle');
                
                noteIndex = (noteIndex + 1) % notes.length;
                setTimeout(playNote, 1000); // æ¯ç§’æ’­æ”¾ä¸€ä¸ªéŸ³ç¬¦
            }
            
            playNote();
        }
        
        // éŸ³æ•ˆæ§åˆ¶
        function toggleMusic() {
            musicEnabled = !musicEnabled;
            musicBtn.textContent = musicEnabled ? 'ğŸµ' : 'ğŸ”‡';
            musicBtn.classList.toggle('muted', !musicEnabled);
            
            if (musicEnabled && gameRunning) {
                playBackgroundMusic();
            }
            
            localStorage.setItem('snakeMusicEnabled', musicEnabled);
        }
        
        function toggleSound() {
            soundEnabled = !soundEnabled;
            soundBtn.textContent = soundEnabled ? 'ğŸ”Š' : 'ğŸ”‡';
            soundBtn.classList.toggle('muted', !soundEnabled);
            
            localStorage.setItem('snakeSoundEnabled', soundEnabled);
        }
        
        // åŠ è½½éŸ³æ•ˆè®¾ç½®
        function loadAudioSettings() {
            const savedMusic = localStorage.getItem('snakeMusicEnabled');
            const savedSound = localStorage.getItem('snakeSoundEnabled');
            
            if (savedMusic !== null) {
                musicEnabled = savedMusic === 'true';
                musicBtn.textContent = musicEnabled ? 'ğŸµ' : 'ğŸ”‡';
                musicBtn.classList.toggle('muted', !musicEnabled);
            }
            
            if (savedSound !== null) {
                soundEnabled = savedSound === 'true';
                soundBtn.textContent = soundEnabled ? 'ğŸ”Š' : 'ğŸ”‡';
                soundBtn.classList.toggle('muted', !soundEnabled);
            }
        }
        
        // æ¸¸æˆä»£ç 
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const scoreElement = document.getElementById('score');
        const speedElement = document.getElementById('speed');
        const finalScoreElement = document.getElementById('finalScore');
        const gameOverElement = document.getElementById('gameOver');
        const restartBtn = document.getElementById('restartBtn');
        const speedSelection = document.getElementById('speedSelection');
        const gameContainer = document.getElementById('gameContainer');
        const helpBtn = document.getElementById('helpBtn');
        const instructions = document.getElementById('instructions');
        
        // åŠ¨æ€è®¾ç½®ç”»å¸ƒå¤§å°ä¸ºå…¨å±
        function resizeCanvas() {
            const screenWidth = window.innerWidth;
            const screenHeight = window.innerHeight;
            
            // è®¾ç½®ç”»å¸ƒä¸ºå…¨å±
            canvas.width = screenWidth;
            canvas.height = screenHeight;
            
            // è®¡ç®—åˆé€‚çš„æ–¹å—å¤§å°
            const minDimension = Math.min(screenWidth, screenHeight);
            blockSize = Math.floor(minDimension / 25); // ç¡®ä¿æœ‰è¶³å¤Ÿçš„æ¸¸æˆç©ºé—´
            
            // è®¡ç®—æ§åˆ¶åŒºåŸŸé«˜åº¦ï¼ˆå¤§çº¦200pxï¼‰
            const controlsHeight = 200;
            const controlsBlocks = Math.ceil(controlsHeight / blockSize);
            
            // è®¡ç®—å®é™…å¯ç”¨çš„ç»¿è‰²æ¸¸æˆåŒºåŸŸ
            const greenAreaHeight = screenHeight - controlsHeight;
            const availableHeight = Math.floor(greenAreaHeight / blockSize);
            
            // è®¡ç®—æ¸¸æˆç½‘æ ¼ - å®½åº¦å…¨å±ï¼Œé«˜åº¦åªåˆ°ç»¿è‰²åŒºåŸŸ
            width = Math.floor(screenWidth / blockSize);
            height = availableHeight; // åªä½¿ç”¨ç»¿è‰²åŒºåŸŸçš„é«˜åº¦
            
            console.log('Canvas resized to fullscreen:', screenWidth, 'x', screenHeight);
            console.log('Block size:', blockSize);
            console.log('Controls height:', controlsHeight, 'px (', controlsBlocks, 'blocks)');
            console.log('Green area height:', greenAreaHeight, 'px (', availableHeight, 'blocks)');
            console.log('Game grid:', width, 'x', height);
            console.log('Max positions - X:', width - 1, 'Y:', height - 1);
        }
        
        // æ¸¸æˆè®¾ç½® - åŠ¨æ€è®¡ç®—
        let blockSize = 20;
        let width = 15;
        let height = 20;
        
        // æ¸¸æˆçŠ¶æ€
        let snake = [];
        let food = {};
        let direction = 'right';
        let nextDirection = 'right';
        let score = 0;
        let gameRunning = true;
        let gameSpeed = 150;
        let gameInterval;
        
        // é£Ÿç‰©ç±»å‹
        const foodTypes = [
            {color: '#e74c3c', name: 'Apple'},
            {color: '#ffffff', name: 'Egg'},
            {color: '#ffffff', name: 'Mouse'},
            {color: '#3498db', name: 'Bug'}
        ];
        let currentFoodType = foodTypes[0];
        
        // åˆå§‹åŒ–è›‡çš„ä½ç½® - åœ¨å±å¹•ä¸­å¤®
        function initSnakePosition() {
            const centerX = Math.floor(width / 2);
            const centerY = Math.floor(height / 2);
            snake = [
                {x: centerX, y: centerY},
                {x: centerX - 1, y: centerY},
                {x: centerX - 2, y: centerY}
            ];
        }
        
        // å¾®ä¿¡æµè§ˆå™¨ç‰¹æ®Šå¤„ç† - é˜²æ­¢é¡µé¢æ»šåŠ¨å’Œç¼©æ”¾
        document.addEventListener('touchmove', function(e) {
            e.preventDefault();
        }, { passive: false });
        
        document.addEventListener('touchstart', function(e) {
            e.preventDefault();
        }, { passive: false });
        
        document.addEventListener('gesturestart', function(e) {
            e.preventDefault();
        }, { passive: false });
        
        document.addEventListener('gesturechange', function(e) {
            e.preventDefault();
        }, { passive: false });
        
        document.addEventListener('gestureend', function(e) {
            e.preventDefault();
        }, { passive: false });
        
        // éŸ³æ•ˆæŒ‰é’®äº‹ä»¶
        function handleMusicClick(e) {
            e.preventDefault();
            e.stopPropagation();
            toggleMusic();
        }
        
        function handleSoundClick(e) {
            e.preventDefault();
            e.stopPropagation();
            toggleSound();
        }
        
        musicBtn.addEventListener('click', handleMusicClick);
        musicBtn.addEventListener('touchend', handleMusicClick);
        soundBtn.addEventListener('click', handleSoundClick);
        soundBtn.addEventListener('touchend', handleSoundClick);
        
        // å¸®åŠ©æŒ‰é’®äº‹ä»¶ - å¾®ä¿¡ä¼˜åŒ–
        function handleHelpClick(e) {
            e.preventDefault();
            e.stopPropagation();
            instructions.style.display = instructions.style.display === 'none' ? 'block' : 'none';
        }
        
        helpBtn.addEventListener('click', handleHelpClick);
        helpBtn.addEventListener('touchend', handleHelpClick);
        
        // é€Ÿåº¦é€‰æ‹©äº‹ä»¶ - å¾®ä¿¡ä¼˜åŒ–
        function handleSpeedClick(e) {
            e.preventDefault();
            e.stopPropagation();
            const selectedSpeed = parseInt(this.dataset.speed);
            console.log('Speed selected:', selectedSpeed);
            // æ’­æ”¾æŒ‰é’®ç‚¹å‡»éŸ³æ•ˆ
            playSound(600, 0.1, 'sine');
            startGame(selectedSpeed);
        }
        
        document.querySelectorAll('.speedButton').forEach(function(button) {
            button.addEventListener('click', handleSpeedClick);
            button.addEventListener('touchend', handleSpeedClick);
            button.addEventListener('touchstart', function(e) {
                e.preventDefault();
            }, { passive: false });
        });
        
        // å¼€å§‹æ¸¸æˆ
        function startGame(speedLevel) {
            console.log('Starting game with speed level:', speedLevel);
            speedSelection.style.display = 'none';
            gameContainer.style.display = 'block';
            
            // é‡æ–°è°ƒæ•´ç”»å¸ƒå¤§å°ä¸ºå…¨å±
            resizeCanvas();
            
            const speedMap = {1: 6, 2: 8, 3: 12, 4: 16, 5: 20};
            gameSpeed = 1000 / speedMap[speedLevel];
            speedElement.textContent = speedLevel;
            
            initGame();
            gameInterval = setInterval(gameLoop, gameSpeed);
            
            // å¯åŠ¨èƒŒæ™¯éŸ³ä¹
            if (musicEnabled) {
                playBackgroundMusic();
            }
        }
        
        // åˆå§‹åŒ–æ¸¸æˆ
        function initGame() {
            initSnakePosition();
            direction = 'right';
            nextDirection = 'right';
            score = 0;
            gameRunning = true;
            generateFood();
            updateUI();
            gameOverElement.style.display = 'none';
        }
        
        // ç”Ÿæˆé£Ÿç‰© - åªåœ¨ç»¿è‰²æ¸¸æˆåŒºåŸŸå†…ç”Ÿæˆ
        function generateFood() {
            currentFoodType = foodTypes[Math.floor(Math.random() * foodTypes.length)];
            
            do {
                food = {
                    x: Math.floor(Math.random() * width),
                    y: Math.floor(Math.random() * height) // åªåœ¨ç»¿è‰²æ¸¸æˆåŒºåŸŸå†…ç”Ÿæˆ
                };
            } while (snake.some(function(segment) {
                return segment.x === food.x && segment.y === food.y;
            }));
            
            console.log('ç”Ÿæˆé£Ÿç‰©ä½ç½®:', food.x, food.y, 'ç»¿è‰²æ¸¸æˆåŒºåŸŸ:', width, 'x', height);
        }
        
        // æ›´æ–°UI
        function updateUI() {
            scoreElement.textContent = score;
        }
        
        // ç»˜åˆ¶è›‡å¤´
        function drawSnakeHead(x, y, dir) {
            ctx.fillStyle = '#ffff00';
            ctx.fillRect(x * blockSize, y * blockSize, blockSize, blockSize);
            
            ctx.strokeStyle = '#ffa500';
            ctx.lineWidth = 2;
            ctx.strokeRect(x * blockSize, y * blockSize, blockSize, blockSize);
            
            ctx.fillStyle = '#ffffff';
            const eyeSize = Math.max(2, Math.floor(blockSize / 5));
            if (dir === 'right') {
                ctx.fillRect(x * blockSize + blockSize - eyeSize * 2, y * blockSize + eyeSize, eyeSize, eyeSize);
                ctx.fillRect(x * blockSize + blockSize - eyeSize * 2, y * blockSize + blockSize - eyeSize * 2, eyeSize, eyeSize);
                ctx.fillStyle = '#000000';
                ctx.fillRect(x * blockSize + blockSize - eyeSize * 2 + 1, y * blockSize + eyeSize + 1, Math.max(1, eyeSize - 2), Math.max(1, eyeSize - 2));
                ctx.fillRect(x * blockSize + blockSize - eyeSize * 2 + 1, y * blockSize + blockSize - eyeSize * 2 + 1, Math.max(1, eyeSize - 2), Math.max(1, eyeSize - 2));
            } else if (dir === 'left') {
                ctx.fillStyle = '#ffffff';
                ctx.fillRect(x * blockSize + eyeSize, y * blockSize + eyeSize, eyeSize, eyeSize);
                ctx.fillRect(x * blockSize + eyeSize, y * blockSize + blockSize - eyeSize * 2, eyeSize, eyeSize);
                ctx.fillStyle = '#000000';
                ctx.fillRect(x * blockSize + eyeSize + 1, y * blockSize + eyeSize + 1, Math.max(1, eyeSize - 2), Math.max(1, eyeSize - 2));
                ctx.fillRect(x * blockSize + eyeSize + 1, y * blockSize + blockSize - eyeSize * 2 + 1, Math.max(1, eyeSize - 2), Math.max(1, eyeSize - 2));
            } else if (dir === 'up') {
                ctx.fillStyle = '#ffffff';
                ctx.fillRect(x * blockSize + eyeSize, y * blockSize + eyeSize, eyeSize, eyeSize);
                ctx.fillRect(x * blockSize + blockSize - eyeSize * 2, y * blockSize + eyeSize, eyeSize, eyeSize);
                ctx.fillStyle = '#000000';
                ctx.fillRect(x * blockSize + eyeSize + 1, y * blockSize + eyeSize + 1, Math.max(1, eyeSize - 2), Math.max(1, eyeSize - 2));
                ctx.fillRect(x * blockSize + blockSize - eyeSize * 2 + 1, y * blockSize + eyeSize + 1, Math.max(1, eyeSize - 2), Math.max(1, eyeSize - 2));
            } else if (dir === 'down') {
                ctx.fillStyle = '#ffffff';
                ctx.fillRect(x * blockSize + eyeSize, y * blockSize + blockSize - eyeSize * 2, eyeSize, eyeSize);
                ctx.fillRect(x * blockSize + blockSize - eyeSize * 2, y * blockSize + blockSize - eyeSize * 2, eyeSize, eyeSize);
                ctx.fillStyle = '#000000';
                ctx.fillRect(x * blockSize + eyeSize + 1, y * blockSize + blockSize - eyeSize * 2 + 1, Math.max(1, eyeSize - 2), Math.max(1, eyeSize - 2));
                ctx.fillRect(x * blockSize + blockSize - eyeSize * 2 + 1, y * blockSize + blockSize - eyeSize * 2 + 1, Math.max(1, eyeSize - 2), Math.max(1, eyeSize - 2));
            }
        }
        
        // ç»˜åˆ¶è›‡èº«
        function drawSnakeBody(x, y) {
            ctx.fillStyle = '#ffff00';
            ctx.beginPath();
            ctx.arc(x * blockSize + blockSize/2, y * blockSize + blockSize/2, blockSize/2 - 2, 0, 2 * Math.PI);
            ctx.fill();
            
            ctx.strokeStyle = '#ffa500';
            ctx.lineWidth = 2;
            ctx.stroke();
            
            ctx.fillStyle = '#006400';
            const dotSize = Math.max(1, Math.floor(blockSize / 10));
            for (let i = 0; i < 3; i++) {
                const dotX = x * blockSize + 5 + i * 5;
                const dotY = y * blockSize + 8 + (i % 2) * 4;
                ctx.fillRect(dotX, dotY, dotSize, dotSize);
            }
        }
        
        // ç»˜åˆ¶é£Ÿç‰©
        function drawFood() {
            if (currentFoodType.name === 'Apple') {
                ctx.fillStyle = currentFoodType.color;
                ctx.beginPath();
                ctx.arc(food.x * blockSize + blockSize/2, food.y * blockSize + blockSize/2, blockSize/2 - 2, 0, 2 * Math.PI);
                ctx.fill();
                
                ctx.fillStyle = '#ff6666';
                ctx.beginPath();
                ctx.arc(food.x * blockSize + blockSize/2 - 2, food.y * blockSize + blockSize/2 - 2, 3, 0, 2 * Math.PI);
                ctx.fill();
                
                ctx.fillStyle = '#8b4513';
                ctx.fillRect(food.x * blockSize + blockSize/2 - 1, food.y * blockSize + 2, 2, 4);
                
                ctx.fillStyle = '#008000';
                ctx.fillRect(food.x * blockSize + blockSize/2 + 1, food.y * blockSize + 1, 4, 3);
                
            } else if (currentFoodType.name === 'Egg') {
                ctx.fillStyle = currentFoodType.color;
                ctx.fillRect(food.x * blockSize + 2, food.y * blockSize + 4, blockSize - 4, blockSize - 8);
                ctx.strokeStyle = '#c8c8c8';
                ctx.lineWidth = 1;
                ctx.strokeRect(food.x * blockSize + 2, food.y * blockSize + 4, blockSize - 4, blockSize - 8);
                
                ctx.fillStyle = '#ffffff';
                ctx.fillRect(food.x * blockSize + blockSize/2 - 2, food.y * blockSize + blockSize/2 - 1, 4, 4);
                
            } else if (currentFoodType.name === 'Mouse') {
                ctx.fillStyle = currentFoodType.color;
                ctx.beginPath();
                ctx.arc(food.x * blockSize + blockSize/2, food.y * blockSize + blockSize/2, blockSize/2 - 2, 0, 2 * Math.PI);
                ctx.fill();
                
                ctx.fillStyle = '#ffb6c1';
                ctx.beginPath();
                ctx.arc(food.x * blockSize + blockSize/2 - 4, food.y * blockSize + blockSize/2 - 4, 3, 0, 2 * Math.PI);
                ctx.fill();
                ctx.beginPath();
                ctx.arc(food.x * blockSize + blockSize/2 + 4, food.y * blockSize + blockSize/2 - 4, 3, 0, 2 * Math.PI);
                ctx.fill();
                
                ctx.fillStyle = '#000000';
                ctx.fillRect(food.x * blockSize + blockSize/2 - 2, food.y * blockSize + blockSize/2 - 1, 1, 1);
                ctx.fillRect(food.x * blockSize + blockSize/2 + 2, food.y * blockSize + blockSize/2 - 1, 1, 1);
                
                ctx.fillStyle = '#ffb6c1';
                ctx.fillRect(food.x * blockSize + blockSize/2, food.y * blockSize + blockSize/2 + 1, 1, 1);
                
            } else if (currentFoodType.name === 'Bug') {
                ctx.fillStyle = currentFoodType.color;
                ctx.fillRect(food.x * blockSize + 3, food.y * blockSize + 6, blockSize - 6, blockSize - 12);
                
                ctx.fillStyle = '#0000aa';
                ctx.beginPath();
                ctx.arc(food.x * blockSize + blockSize/2, food.y * blockSize + blockSize/2, 4, 0, 2 * Math.PI);
                ctx.fill();
                
                ctx.strokeStyle = '#000000';
                ctx.lineWidth = 1;
                ctx.beginPath();
                ctx.moveTo(food.x * blockSize + blockSize/2 - 2, food.y * blockSize + blockSize/2 - 2);
                ctx.lineTo(food.x * blockSize + blockSize/2 - 4, food.y * blockSize + blockSize/2 - 4);
                ctx.stroke();
                ctx.beginPath();
                ctx.moveTo(food.x * blockSize + blockSize/2 + 2, food.y * blockSize + blockSize/2 - 2);
                ctx.lineTo(food.x * blockSize + blockSize/2 + 4, food.y * blockSize + blockSize/2 - 4);
                ctx.stroke();
            }
        }
        
        // ç»˜åˆ¶æ¸¸æˆ
        function draw() {
            // ç»˜åˆ¶ç»¿è‰²æ¸¸æˆåŒºåŸŸ
            ctx.fillStyle = '#27ae60';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            // ç»˜åˆ¶æ¸¸æˆåŒºåŸŸè¾¹ç•Œçº¿ï¼ˆè®©ç©å®¶æ¸…æ¥šçœ‹åˆ°è¾¹ç•Œï¼‰
            ctx.strokeStyle = '#1e8449';
            ctx.lineWidth = 3;
            ctx.strokeRect(0, 0, canvas.width, height * blockSize);
            
            // ç»˜åˆ¶è›‡
            snake.forEach(function(segment, index) {
                if (index === 0) {
                    drawSnakeHead(segment.x, segment.y, direction);
                } else {
                    drawSnakeBody(segment.x, segment.y);
                }
            });
            
            // ç»˜åˆ¶é£Ÿç‰©
            drawFood();
        }
        
        // ç§»åŠ¨è›‡
        function moveSnake() {
            if (!gameRunning) return;
            
            direction = nextDirection;
            const head = {x: snake[0].x, y: snake[0].y};
            
            switch (direction) {
                case 'up': head.y--; break;
                case 'down': head.y++; break;
                case 'left': head.x--; break;
                case 'right': head.x++; break;
            }
            
            // è¾¹ç•Œæ£€æµ‹ï¼šè›‡åªèƒ½åœ¨ç»¿è‰²æ¸¸æˆåŒºåŸŸå†…ç§»åŠ¨
            if (head.x < 0 || head.x >= width || head.y < 0 || head.y >= height ||
                snake.some(function(segment) {
                    return segment.x === head.x && segment.y === head.y;
                })) {
                console.log('æ¸¸æˆç»“æŸ - è¾¹ç•Œæ£€æµ‹:', head.x, head.y, 'ç»¿è‰²æ¸¸æˆåŒºåŸŸ:', width, 'x', height);
                // æ’­æ”¾æ’å¢™éŸ³æ•ˆ
                playSound(150, 0.5, 'sawtooth'); // æ²‰é—·çš„æ’å‡»å£°
                gameOver();
                return;
            }
            
            snake.unshift(head);
            
            if (head.x === food.x && head.y === food.y) {
                score += 1;
                generateFood();
                updateUI();
                // æ’­æ”¾åƒåˆ°é£Ÿç‰©éŸ³æ•ˆ
                playSound(800, 0.2, 'square'); // æ¸…è„†çš„"å’”åš“"å£°
            } else {
                snake.pop();
            }
        }
        
        // æ¸¸æˆç»“æŸ
        function gameOver() {
            gameRunning = false;
            finalScoreElement.textContent = score;
            gameOverElement.style.display = 'block';
            
            // æ’­æ”¾æ¸¸æˆç»“æŸéŸ³æ•ˆ
            playSound(200, 1.0, 'sawtooth'); // æ‚²ä¼¤çš„éŸ³æ•ˆ
        }
        
        // æ¸¸æˆå¾ªç¯
        function gameLoop() {
            moveSnake();
            draw();
        }
        
        // æ–¹å‘æŒ‰é’®äº‹ä»¶ - å¾®ä¿¡ä¼˜åŒ–
        function addButtonEvents(buttonId, newDirection) {
            const button = document.getElementById(buttonId);
            const handler = function(e) {
                e.preventDefault();
                e.stopPropagation();
                if (newDirection === 'up' && direction !== 'down') {
                    nextDirection = 'up';
                    playSound(400, 0.1, 'sine'); // æ–¹å‘æ”¹å˜éŸ³æ•ˆ
                }
                else if (newDirection === 'down' && direction !== 'up') {
                    nextDirection = 'down';
                    playSound(400, 0.1, 'sine');
                }
                else if (newDirection === 'left' && direction !== 'right') {
                    nextDirection = 'left';
                    playSound(400, 0.1, 'sine');
                }
                else if (newDirection === 'right' && direction !== 'left') {
                    nextDirection = 'right';
                    playSound(400, 0.1, 'sine');
                }
            };
            
            button.addEventListener('click', handler);
            button.addEventListener('touchend', handler);
            button.addEventListener('touchstart', function(e) {
                e.preventDefault();
            }, { passive: false });
        }
        
        addButtonEvents('upBtn', 'up');
        addButtonEvents('downBtn', 'down');
        addButtonEvents('leftBtn', 'left');
        addButtonEvents('rightBtn', 'right');
        
        // é‡æ–°å¼€å§‹æŒ‰é’®äº‹ä»¶
        function handleRestart(e) {
            e.preventDefault();
            e.stopPropagation();
            speedSelection.style.display = 'flex';
            gameContainer.style.display = 'none';
            clearInterval(gameInterval);
        }
        
        restartBtn.addEventListener('click', handleRestart);
        restartBtn.addEventListener('touchend', handleRestart);
        
        // é˜²æ­¢é”®ç›˜äº‹ä»¶
        document.addEventListener('keydown', function(e) {
            e.preventDefault();
            switch(e.key) {
                case 'ArrowUp':
                    if (direction !== 'down') nextDirection = 'up';
                    break;
                case 'ArrowDown':
                    if (direction !== 'up') nextDirection = 'down';
                    break;
                case 'ArrowLeft':
                    if (direction !== 'right') nextDirection = 'left';
                    break;
                case 'ArrowRight':
                    if (direction !== 'left') nextDirection = 'right';
                    break;
            }
        });
        
        // å¾®ä¿¡æµè§ˆå™¨ç‰¹æ®Šå¤„ç†
        if (typeof WeixinJSBridge !== 'undefined') {
            WeixinJSBridge.call('hideOptionMenu');
        }
        
        // æ£€æµ‹å¾®ä¿¡æµè§ˆå™¨
        function isWeChat() {
            return /MicroMessenger/i.test(navigator.userAgent);
        }
        
        if (isWeChat()) {
            console.log('Running in WeChat browser');
            // å¾®ä¿¡æµè§ˆå™¨ç‰¹æ®Šä¼˜åŒ–
            document.addEventListener('gesturestart', function(e) {
                e.preventDefault();
            }, { passive: false });
            
            document.addEventListener('gesturechange', function(e) {
                e.preventDefault();
            }, { passive: false });
            
            document.addEventListener('gestureend', function(e) {
                e.preventDefault();
            }, { passive: false });
        }
        
        // çª—å£å¤§å°æ”¹å˜æ—¶é‡æ–°è°ƒæ•´ç”»å¸ƒ
        window.addEventListener('resize', function() {
            if (gameContainer.style.display !== 'none') {
                resizeCanvas();
            }
        });
        
        // é¡µé¢åŠ è½½å®Œæˆåçš„åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            console.log('PWA Snake Game loaded successfully - å¾®ä¿¡å…¨å±ç‰ˆæœ¬');
            
            // åˆå§‹åŒ–éŸ³æ•ˆç³»ç»Ÿ
            initAudio();
            loadAudioSettings();
        });
    </script>
</body>
</html> 